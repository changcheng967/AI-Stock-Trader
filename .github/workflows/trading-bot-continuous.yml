name: ðŸ”„ Continuous Trading Bot (Market Hours)

# Advanced workflow that runs continuously during market hours
# Uses workflow restart to bypass the 6-hour job limit
on:
  workflow_dispatch:  # Manual trigger
    inputs:
      duration_hours:
        description: 'How long to run (hours, max 6)'
        required: true
        default: '6'
        type: choice
        options:
          - '1'
          - '2'
          - '3'
          - '4'
          - '5'
          - '6'

  schedule:
    # Start at market open (9:30 AM ET = 13:30 UTC during EDT, 14:30 UTC during EST)
    # This example uses 14:30 UTC (assuming EST)
    - cron: '30 14 * * 1-5'  # 9:30 AM ET, Mon-Fri

env:
  PYTHON_VERSION: '3.11'

jobs:
  continuous-trading:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hours max

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ðŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ðŸ” Load Environment
        run: |
          echo "ALPACA_API_KEY=${{ secrets.ALPACA_API_KEY }}" >> .env
          echo "ALPACA_SECRET_KEY=${{ secrets.ALPACA_SECRET_KEY }}" >> .env
          echo "ALPACA_BASE_URL=${{ secrets.ALPACA_BASE_URL || 'https://paper-api.alpaca.markets' }}" >> .env
          echo "ALPACA_DATA_URL=${{ secrets.ALPACA_DATA_URL || 'https://data.alpaca.markets' }}" >> .env
          if [ -n "${{ secrets.NIM_API_KEY }}" ]; then
            echo "NIM_API_KEY=${{ secrets.NIM_API_KEY }}" >> .env
          fi

      - name: ðŸ§ª Validate Setup
        run: |
          python -c "
          import os
          from alpaca_client import AlpacaClient
          from dotenv import load_dotenv

          load_dotenv()
          print('âœ… Testing Alpaca connection...')

          client = AlpacaClient()
          account = client.get_account()

          print(f'âœ… Connected successfully!')
          print(f'   Account: ${account[\"portfolio_value\"]:,.2f}')
          print(f'   Cash: ${account[\"cash\"]:,.2f}')
          print(f'   Buying Power: ${account[\"buying_power\"]:,.2f}')
          print(f'   Mode: Paper Trading')
          "

      - name: ðŸ¤– Run Trading Bot
        env:
          ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
          ALPACA_BASE_URL: ${{ secrets.ALPACA_BASE_URL || 'https://paper-api.alpaca.markets' }}
          ALPACA_DATA_URL: ${{ secrets.ALPACA_DATA_URL || 'https://data.alpaca.markets' }}
          NIM_API_KEY: ${{ secrets.NIM_API_KEY || '' }}
        run: |
          # Calculate run time in minutes
          DURATION_MINUTES=$((${{ inputs.duration_hours || 6 }} * 60 - 5))  # 5 min buffer
          echo "â° Running for $DURATION_MINUTES minutes"

          # Create logs directory
          mkdir -p logs

          # Run bot
          timeout ${DURATION_MINUTES}m python run_bot.py 2>&1 | tee logs/bot.log

          echo ""
          echo "âœ… Bot run completed"

      - name: ðŸ“Š Process & Upload Logs
        if: always()
        run: |
          # Create summary
          echo "# Trading Bot Run Summary" > logs/SUMMARY.md
          echo "" >> logs/SUMMARY.md
          echo "**Run ID:** ${{ github.run_id }}" >> logs/SUMMARY.md
          echo "**Duration:** ${{ inputs.duration_hours || 6 }} hours" >> logs/SUMMARY.md
          echo "**Date:** $(date -u)" >> logs/SUMMARY.md
          echo "" >> logs/SUMMARY.md

          # Extract key metrics from logs
          echo "## Key Metrics" >> logs/SUMMARY.md
          grep -E "Portfolio:|Total Trades:|Win Rate:|P&L:" logs/bot.log | tail -20 >> logs/SUMMARY.md || echo "No metrics found"

      - name: ðŸ“¤ Upload Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: continuous-bot-logs-${{ github.run_number }}
          path: logs/
          retention-days: 30

      - name: ðŸ“ˆ Upload Performance Data
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: continuous-performance-${{ github.run_number }}
          path: data/
          retention-days: 90
          if-no-files-found: ignore

      - name: ðŸŽ¯ Create Summary
        if: always()
        run: |
          echo "=========================================="
          echo "ðŸ”„ CONTINUOUS TRADING BOT - COMPLETE"
          echo "=========================================="
          echo ""
          echo "ðŸ“Š Run Details:"
          echo "  Duration: ${{ inputs.duration_hours || 6 }} hours"
          echo "  Status: ${{ job.status }}"
          echo ""
          echo "ðŸ“¦ Artifacts:"
          echo "  - continuous-bot-logs-${{ github.run_number }}"
          echo "  - continuous-performance-${{ github.run_number }}"
          echo ""
          echo "ðŸ”— View Details:"
          echo "  ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "=========================================="
