name: ğŸ”„ Continuous Trading Bot (Market Hours)

on:
  workflow_dispatch:
    inputs:
      duration_hours:
        description: 'How long to run (hours, max 6)'
        required: true
        default: '6'
        type: choice
        options: ['1', '2', '3', '4', '5', '6']
      is_recursive:
        description: 'Restart after completion?'
        type: boolean
        default: false

  schedule:
    - cron: '30 14 * * 1-5' # 9:30 AM ET (EST)

env:
  PYTHON_VERSION: '3.12'
  ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
  ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
  ALPACA_BASE_URL: ${{ secrets.ALPACA_BASE_URL || 'https://paper-api.alpaca.markets' }}
  ALPACA_DATA_URL: ${{ secrets.ALPACA_DATA_URL || 'https://data.alpaca.markets' }}
  NIM_API_KEY: ${{ secrets.NIM_API_KEY }}

jobs:
  continuous-trading:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          # Using "numpy<2" is recommended here if your requirements.txt is still using older Pandas
          pip install -r requirements.txt

      - name: ğŸ§ª Validate Setup
        run: |
          python <<EOF
          import os
          from alpaca_client import AlpacaClient
          
          print('ğŸ”Œ Testing Alpaca connection...')
          try:
              client = AlpacaClient()
              account = client.get_account()
              
              portfolio = account.get('portfolio_value', '0.00')
              buying_power = account.get('buying_power', '0.00')
              
              print(f'âœ… Connected Successfully!')
              print(f'   Portfolio Value: ${portfolio}')
              print(f'   Buying Power:    ${buying_power}')
          except Exception as e:
              print(f'âŒ Setup Validation Failed: {e}')
              exit(1)
          EOF

      - name: ğŸ¤– Run Trading Bot
        run: |
          # Calculate minutes: (Hours * 60) - 10 min buffer for cleanup
          DURATION_MINUTES=$((${{ github.event.inputs.duration_hours || 6 }} * 60 - 10))
          echo "â° Bot scheduled to run for $DURATION_MINUTES minutes"
          
          mkdir -p logs
          
          # Use timeout to prevent the job from being killed abruptly by GitHub
          # This allows the workflow to move to the 'Upload Logs' step even after bot stops
          timeout ${DURATION_MINUTES}m python run_bot.py 2>&1 | tee logs/bot.log || echo "Bot process reached timeout or ended."

      - name: ğŸ“¤ Upload Logs & Data
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trading-artifacts-run-${{ github.run_number }}
          path: |
            logs/
            data/
          retention-days: 7

      - name: ğŸ”„ Chain-Restart Workflow
        if: github.event.inputs.is_recursive == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ”„ Recursive mode enabled. Triggering next cycle..."
          gh workflow run "Continuous Trading Bot (Market Hours)" \
            -f duration_hours="${{ github.event.inputs.duration_hours }}" \
            -f is_recursive="true"

      - name: ğŸ¯ Final Summary
        if: always()
        run: |
          echo "=========================================="
          echo "ğŸ Run ID: ${{ github.run_id }} Status: ${{ job.status }}"
          echo "=========================================="