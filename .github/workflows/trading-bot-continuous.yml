name: ðŸ”„ Continuous Trading Bot (Market Hours)

on:
  workflow_dispatch:
    inputs:
      duration_hours:
        description: 'How long to run (hours, max 6)'
        required: true
        default: '6'
        type: choice
        options: ['1', '2', '3', '4', '5', '6']
      is_recursive:
        description: 'Restart after completion?'
        type: boolean
        default: false

  schedule:
    - cron: '30 14 * * 1-5' # 9:30 AM ET (EST)

env:
  PYTHON_VERSION: '3.12'
  # Global Env for the whole Job
  ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
  ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
  ALPACA_BASE_URL: ${{ secrets.ALPACA_BASE_URL || 'https://paper-api.alpaca.markets' }}
  ALPACA_DATA_URL: ${{ secrets.ALPACA_DATA_URL || 'https://data.alpaca.markets' }}
  NIM_API_KEY: ${{ secrets.NIM_API_KEY }}

jobs:
  continuous-trading:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5 # Upgraded to v5 for better stability
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ðŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ðŸ§ª Validate Setup
        run: |
          python -c "
          from alpaca_client import AlpacaClient
          print('âœ… Testing Alpaca connection...')
          client = AlpacaClient()
          account = client.get_account()
          print(f'âœ… Connected! Portfolio: ${account[\"portfolio_value\"]}')
          "

      - name: ðŸ¤– Run Trading Bot
        run: |
          DURATION_MINUTES=$((${{ inputs.duration_hours || 6 }} * 60 - 10)) 
          echo "â° Running for $DURATION_MINUTES minutes"
          mkdir -p logs
          # Use timeout to ensure we exit before the GitHub 6h hard-cap
          timeout ${DURATION_MINUTES}m python run_bot.py 2>&1 | tee logs/bot.log || echo 'Bot stopped by timeout'

      - name: ðŸ“Š Process & Upload Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bot-logs-run-${{ github.run_number }}
          path: |
            logs/
            data/
          retention-days: 7

      # RESTART LOGIC: This allows the bot to "loop"
      - name: ðŸ”„ Chain-Restart Workflow
        if: github.event.inputs.is_recursive == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Triggering next cycle..."
          gh workflow run "Continuous Trading Bot (Market Hours)" \
            -f duration_hours="${{ github.event.inputs.duration_hours }}" \
            -f is_recursive="true"