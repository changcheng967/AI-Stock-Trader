name: ü§ñ AI Trading Bot

# Run the trading bot during market hours (9:30 AM - 4:00 PM ET, Mon-Fri)
on:
  schedule:
    # Run every 5 minutes during market hours
    - cron: '*/5 9-15 * * 1-5'  # 9:00 AM - 3:55 PM ET, every 5 min, Mon-Fri
    # Note: GitHub Actions uses UTC, so this is actually 9:00-15:55 UTC
    # For ET (UTC-5/-4), you'd need to adjust the hours

  workflow_dispatch:  # Allow manual triggering

env:
  PYTHON_VERSION: '3.11'
  BOT_RUN_TIME_MINUTES: 55  # Run for 55 min (under 1 hour for safety margin)

jobs:
  trading-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # Maximum 1 hour per run (GitHub Actions limit)

    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4

      - name: üêç Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: üì¶ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: üîê Verify Environment Variables
        run: |
          echo "Checking required secrets..."
          if [ -z "${{ secrets.ALPACA_API_KEY }}" ]; then
            echo "‚ùå ALPACA_API_KEY not set"
            exit 1
          fi
          if [ -z "${{ secrets.ALPACA_SECRET_KEY }}" ]; then
            echo "‚ùå ALPACA_SECRET_KEY not set"
            exit 1
          fi
          echo "‚úÖ All required secrets are set"

      - name: üß™ Run Tests
        run: |
          python test_bot.py
        continue-on-error: false

      - name: ü§ñ Start Trading Bot
        env:
          ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
          ALPACA_BASE_URL: ${{ secrets.ALPACA_BASE_URL || 'https://paper-api.alpaca.markets' }}
          ALPACA_DATA_URL: ${{ secrets.ALPACA_DATA_URL || 'https://data.alpaca.markets' }}
          NIM_API_KEY: ${{ secrets.NIM_API_KEY || '' }}
        run: |
          echo "üöÄ Starting AI Trading Bot..."
          echo "‚è∞ Run time: ${{ env.BOT_RUN_TIME_MINUTES }} minutes"
          echo ""
          echo "Configuration:"
          echo "  - Paper Trading: ${{ secrets.ALPACA_BASE_URL == 'https://paper-api.alpaca.markets' || 'https://paper-api.alpaca.markets' }}"
          echo "  - Market: Paper Trading (Simulated)"
          echo ""

          # Create logs directory
          mkdir -p logs

          # Run bot with timeout
          timeout ${{ env.BOT_RUN_TIME_MINUTES }}m python run_bot.py || exit_code=$?

          # Save exit code for later
          echo $exit_code > bot_exit_code.txt

          # Check if bot exited normally
          if [ -f bot_exit_code.txt ]; then
            exit_code=$(cat bot_exit_code.txt)
            if [ $exit_code -eq 124 ]; then
              echo ""
              echo "‚è∞ Bot stopped after timeout (normal operation)"
            elif [ $exit_code -eq 130 ]; then
              echo ""
              echo "‚úÖ Bot stopped cleanly (Ctrl+C)"
            else
              echo ""
              echo "‚ö†Ô∏è Bot exited with code: $exit_code"
            fi
          fi

      - name: üìä Upload Trading Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trading-logs-${{ github.run_number }}
          path: logs/
          retention-days: 30

      - name: üìà Upload Performance Data
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: performance-data-${{ github.run_number }}
          path: |
            data/performance*.json
            data/trades*.json
          retention-days: 90
          if-no-files-found: ignore

      - name: üìù Bot Summary
        if: always()
        run: |
          echo ""
          echo "=========================================="
          echo "ü§ñ TRADING BOT RUN SUMMARY"
          echo "=========================================="
          echo "Run Number: ${{ github.run_number }}"
          echo "Run ID: ${{ github.run_id }}"
          echo "Workflow: ${{ github.workflow }}"
          echo "Triggered: ${{ github.event_name }}"
          echo ""
          echo "üìä Artifacts saved:"
          echo "  - trading-logs-${{ github.run_number }}"
          echo "  - performance-data-${{ github.run_number }}"
          echo ""
          echo "üîó View logs:"
          echo "  ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "=========================================="

      - name: üìß Notification on Failure
        if: failure()
        run: |
          echo "‚ùå Trading bot run failed!"
          echo "Check the logs for details"

      - name: ‚è∞ Wait for Next Schedule
        if: success()
        run: |
          echo "‚úÖ Bot run completed successfully"
          echo "‚è∞ Next run scheduled in 5 minutes (or at next market open)"
