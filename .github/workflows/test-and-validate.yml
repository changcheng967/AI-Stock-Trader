name: ğŸ§ª Test & Validate Bot

# Run comprehensive tests before enabling trading
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: ğŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ” Lint Code
        run: |
          echo "Running basic syntax checks..."
          python -m py_compile *.py
          echo "âœ… All Python files compile successfully"

      - name: ğŸ§ª Run Unit Tests
        env:
          # Use test credentials
          ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
        run: |
          echo "Running test suite..."
          python test_bot.py

      - name: ğŸ¯ Validate Configuration
        run: |
          python -c "
          import os
          from config import settings

          print('âœ… Configuration loaded successfully')
          print(f'   Max Positions: {settings.max_positions}')
          print(f'   Position Size: {settings.max_position_size * 100}%')
          print(f'   Stop Loss: {settings.stop_loss_pct * 100}%')
          print(f'   Confidence Threshold: 70%')
          "

      - name: ğŸ“Š Validate Data Files
        run: |
          echo "Checking data directory structure..."
          mkdir -p data logs

          # Check if required files exist or can be created
          touch data/.gitkeep
          touch logs/.gitkeep

          echo "âœ… Data directory structure validated"

      - name: ğŸ§ª Market Connection Test
        if: github.event_name == 'workflow_dispatch'
        env:
          ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
          ALPACA_BASE_URL: ${{ secrets.ALPACA_BASE_URL || 'https://paper-api.alpaca.markets' }}
        run: |
          python -c "
          from alpaca_client import AlpacaClient
          from market_data import get_market_data
          from stock_screener import turbo_screener

          print('ğŸ”Œ Testing Alpaca connection...')
          client = AlpacaClient()
          account = client.get_account()
          print(f'âœ… Account: \${account[\"portfolio_value\"]:,.2f}')

          print('ğŸ“Š Testing market data...')
          data = get_market_data(['AAPL'], days=5)
          if not data.empty:
              print(f'âœ… Market data: {len(data)} bars retrieved')

          print('ğŸ” Testing stock screener...')
          opportunities = turbo_screener(max_symbols=5, min_confidence=0.70)
          print(f'âœ… Screener found {len(opportunities)} opportunities')

          print('')
          print('âœ… All connections validated!')
          "

      - name: âœ… Success Message
        if: success()
        run: |
          echo ""
          echo "=========================================="
          echo "âœ… ALL TESTS PASSED"
          echo "=========================================="
          echo ""
          echo "ğŸ¤– The trading bot is ready to deploy!"
          echo ""
          echo "Next steps:"
          echo "  1. Review test results"
          echo "  2. Merge to main branch"
          echo "  3. Trigger trading bot workflow"
          echo "=========================================="

      - name: âŒ Failure Message
        if: failure()
        run: |
          echo ""
          echo "=========================================="
          echo "âŒ TESTS FAILED"
          echo "=========================================="
          echo ""
          echo "Please review the errors above and fix before deploying."
          echo "=========================================="
